{% extends 'base.html' %}
{% load static %}
{% block content %}
    <style>
        @media (max-width: 768px) {
            h2, h5 {
                font-size: 1.2rem;
            }

            .list-group-item {
                font-size: 0.9rem;
            }
        }

        .image-wrapper {
            position: relative;
            min-height: 250px;
        }

        .blurred {
            filter: blur(8px);
            transition: filter 0.5s ease-out;
        }

        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .loader-flower {
            width: 60px;
            height: 60px;
            border: 6px solid #f88db1;
            border-top: 6px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .custom-btn {
            font-size: 1.1rem;
            padding: 10px 20px;
        }

        .fade-in {
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        .fade-in.visible {
            opacity: 1;
        }

        .feedback-popup {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f88db1;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            z-index: 9999;
            font-weight: 500;
        }

        .feedback-popup.visible {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .feedback-popup a {
            color: #fff;
            font-weight: bold;
            margin-left: 10px;
            text-decoration: underline;
        }

        .feedback-popup a:hover {
            text-decoration: none;
        }

    </style>

    <div class="container mt-5">
        <h2 class="text-center">–í–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –±—É–∫–µ—Ç</h2>

        {% if bouquet.generated_image %}
            <div class="image-wrapper my-4">
                <div class="loader-overlay" id="loader">
                    <div class="loader-flower"></div>
                </div>
                <img src="{{ bouquet.generated_image.url }}" class="img-fluid rounded shadow blurred" id="bouquetImage"
                     alt="–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-height: 400px; object-fit: contain;">
            </div>
        {% else %}
            <div class="text-center my-4">
                <div class="loader-flower"></div>
                <p class="text-muted mt-3">üñº –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
            </div>
        {% endif %}
        <div id="feedbackPrompt" class="feedback-popup">
            üéâ –£–¥–µ–ª–∏—Ç–µ –º–∏–Ω—É—Ç—É, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å –Ω–∞—à —Å–µ—Ä–≤–∏—Å!
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSc8Ccv-bqgoOZViup3ncqFxiOmzFp6Wqux08vPxROCUNUVFdQ/viewform?usp=dialog"
               target="_blank">–ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å</a>
        </div>

        <div class="mt-4 fade-in" id="contentBlock">
            <h5>–°–æ—Å—Ç–∞–≤:</h5>
            <ul class="list-group mb-3">
                {% for item in bouquet.custombouquetflower_set.all %}
                    <li class="list-group-item d-flex justify-content-between">
                        üå∏ {{ item.flower.name }} ‚Äî {{ item.quantity }} √ó {{ item.flower.price }} ‚Ç∏
                    </li>
                {% endfor %}
                {% for item in bouquet.custombouquetpackaging_set.all %}
                    <li class="list-group-item d-flex justify-content-between">
                        üéÅ {{ item.packaging.name }} ‚Äî {{ item.quantity }} √ó {{ item.packaging.price }} ‚Ç∏
                    </li>
                {% endfor %}
            </ul>

            <p class="h5 text-end"><strong>–ò—Ç–æ–≥–æ:</strong> {{ bouquet.total_price }} ‚Ç∏</p>

            <div class="d-flex justify-content-between flex-wrap gap-2 mt-4">
                <form method="post" action="{% url 'constructor:clear_constructor' %}" class="w-100">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger w-100 custom-btn">
                        üóë –û—á–∏—Å—Ç–∏—Ç—å –±—É–∫–µ—Ç
                    </button>
                </form>

                <form method="post" action="{% url 'constructor:add_to_cart' %}" class="w-100 mt-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success w-100 custom-btn">
                        üõí –í –∫–æ—Ä–∑–∏–Ω—É
                    </button>
                </form>

            </div>
        </div>
    </div>


    <script>
        window.addEventListener('DOMContentLoaded', function () {
            const image = document.getElementById('bouquetImage');
            const loader = document.getElementById('loader');
            const contentBlock = document.getElementById('contentBlock');
            const feedbackPrompt = document.getElementById('feedbackPrompt');

            if (image && loader && contentBlock) {
                setTimeout(() => {
                    loader.style.display = 'none';
                    image.classList.remove('blurred');
                    contentBlock.classList.add('visible');
                }, 4000);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 6 —Å–µ–∫
            setTimeout(() => {
                if (feedbackPrompt) {
                    feedbackPrompt.classList.add('visible');
                }
            }, 6000);
        });

    </script>
{% endblock %}
